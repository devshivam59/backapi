<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>DhanHQ Watchlist & Live Market</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                    DhanHQ Live Market
                </h1>
                <p class="text-gray-400 mt-2">Real-time watchlist with live price streaming</p>
            </div>
            <div class="flex gap-4">
                <span id="marketStatus" class="px-4 py-2 bg-red-600 rounded-lg font-semibold text-sm">
                    Market Status: CLOSED
                </span>
                <button onclick="openSettings()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition">
                    ‚öôÔ∏è Settings
                </button>
                <a href="/" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition">
                    üìä Instruments
                </a>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 bg-opacity-50 backdrop-blur rounded-xl border border-gray-700 p-6">
                <h3 class="text-gray-400 text-sm font-semibold mb-2">Watchlist Items</h3>
                <p id="watchlistCount" class="text-4xl font-bold text-blue-400">0</p>
            </div>
            <div class="bg-gray-800 bg-opacity-50 backdrop-blur rounded-xl border border-gray-700 p-6">
                <h3 class="text-gray-400 text-sm font-semibold mb-2">Connection Status</h3>
                <p id="connectionStatus" class="text-2xl font-bold text-yellow-400">Loading...</p>
            </div>
            <div class="bg-gray-800 bg-opacity-50 backdrop-blur rounded-xl border border-gray-700 p-6">
                <h3 class="text-gray-400 text-sm font-semibold mb-2">Last Update</h3>
                <p id="lastUpdate" class="text-2xl font-bold text-green-400">--:--:--</p>
            </div>
        </div>

        <!-- Watchlist Table -->
        <div class="bg-gray-800 bg-opacity-50 backdrop-blur rounded-xl border border-gray-700 overflow-hidden">
            <div class="p-6 border-b border-gray-700">
                <h2 class="text-2xl font-bold">My Watchlist</h2>
                <p class="text-gray-400 mt-1">Live prices update automatically during market hours</p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-700 bg-opacity-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Symbol</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Name</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Exchange</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">LTP</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">Change</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">% Change</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-300">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="watchlistTable" class="divide-y divide-gray-700">
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center text-gray-400">
                                <div class="loading">Loading watchlist...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl border border-gray-700 p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-6">DhanHQ API Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Access Token</label>
                    <input type="text" id="accessToken" placeholder="Enter your DhanHQ access token" 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Client ID</label>
                    <input type="text" id="clientId" placeholder="Enter your DhanHQ client ID" 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="saveSettings()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition">
                    Save
                </button>
                <button onclick="closeSettings()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        // Use consistent user token for testing
        const USER_TOKEN = 'user_test123';
        localStorage.setItem('dhanhq_user_token', USER_TOKEN);
        
        let watchlistData = [];
        let priceData = {};
        let userSettings = null;
        let pollingInterval = null;
        
        console.log('[Init] User Token:', USER_TOKEN);

        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    headers: { 'X-User-Token': USER_TOKEN }
                });
                userSettings = await response.json();
                console.log('[Settings] Loaded:', userSettings ? 'Yes' : 'No');
                return userSettings;
            } catch (error) {
                console.error('[Settings] Load failed:', error);
                return null;
            }
        }

        // Load watchlist
        async function loadWatchlist() {
            try {
                console.log('[Watchlist] Loading...');
                const response = await fetch(`${API_BASE}/watchlist`, {
                    headers: { 'X-User-Token': USER_TOKEN }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                watchlistData = await response.json();
                console.log('[Watchlist] Loaded:', watchlistData.length, 'items');
                console.log('[Watchlist] Data:', watchlistData);
                
                document.getElementById('watchlistCount').textContent = watchlistData.length;
                renderWatchlist();
                
                // Start fetching prices if watchlist has items
                if (watchlistData.length > 0) {
                    fetchPrices();
                    startPolling();
                }
            } catch (error) {
                console.error('[Watchlist] Load failed:', error);
                document.getElementById('connectionStatus').textContent = 'Error';
                document.getElementById('watchlistTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-red-400">
                            Failed to load watchlist: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Render watchlist table
        function renderWatchlist() {
            const tbody = document.getElementById('watchlistTable');
            
            console.log('[Render] Rendering', watchlistData.length, 'items');
            
            if (watchlistData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-400">
                            No instruments in watchlist. Add from the <a href="/" class="text-blue-400 hover:underline">Instruments page</a>.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = watchlistData.map(item => {
                const price = priceData[item.security_id] || {};
                const ltp = price.ltp ? (typeof price.ltp === 'number' ? price.ltp.toFixed(2) : price.ltp) : '--';
                const change = price.change || 0;
                const changePercent = price.changePercent || 0;
                const priceClass = change >= 0 ? 'price-up' : 'price-down';

                return `
                    <tr class="hover:bg-gray-750 transition">
                        <td class="px-6 py-4 font-semibold">${item.trading_symbol || item.security_id}</td>
                        <td class="px-6 py-4 text-gray-300">${item.display_name || '--'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 bg-blue-900 text-blue-300 rounded text-xs font-semibold">
                                ${item.exchange_segment}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right font-bold ${priceClass}">${ltp}</td>
                        <td class="px-6 py-4 text-right ${priceClass}">${change >= 0 ? '+' : ''}${typeof change === 'number' ? change.toFixed(2) : change}</td>
                        <td class="px-6 py-4 text-right ${priceClass}">${changePercent >= 0 ? '+' : ''}${typeof changePercent === 'number' ? changePercent.toFixed(2) : changePercent}%</td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="removeFromWatchlist(${item.id})" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm font-semibold transition">
                                üóëÔ∏è Remove
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('[Render] Complete');
        }

        // Fetch prices from API
        async function fetchPrices() {
            if (watchlistData.length === 0) return;
            
            try {
                console.log('[Prices] Fetching for', watchlistData.length, 'instruments');
                
                // Group instruments by exchange segment with integer security IDs
                const grouped = {};
                watchlistData.forEach(item => {
                    const segment = item.exchange_segment;
                    if (!grouped[segment]) {
                        grouped[segment] = [];
                    }
                    grouped[segment].push(parseInt(item.security_id));
                });
                
                console.log('[Prices] Request payload:', grouped);

                const response = await fetch(`${API_BASE}/market/ltp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Token': USER_TOKEN
                    },
                    body: JSON.stringify(grouped)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('[Prices] Received:', result);
                    
                    // Parse DhanHQ response format: {data: {NSE_EQ: {"11536": {last_price: 4520}}}}
                    if (result.status === 'success' && result.data) {
                        Object.keys(result.data).forEach(segment => {
                            Object.keys(result.data[segment]).forEach(secId => {
                                const priceInfo = result.data[segment][secId];
                                priceData[secId] = {
                                    security_id: secId,
                                    ltp: priceInfo.last_price || 0,
                                    prev_close: priceInfo.ohlc?.close || priceInfo.last_price || 0
                                };
                            });
                        });
                        
                        // Re-render table with new prices
                        renderWatchlist();
                        
                        // Update status only if WebSocket is not active
                        if (!wsHandler || !wsHandler.ws || wsHandler.ws.readyState !== WebSocket.OPEN) {
                            document.getElementById('connectionStatus').textContent = 'REST API';
                            document.getElementById('connectionStatus').className = 'px-4 py-2 bg-yellow-600 rounded-lg font-semibold text-sm';
                        }
                        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                    } else {
                        console.error('[Prices] Invalid response:', result);
                        document.getElementById('connectionStatus').textContent = 'Error';
                    }
                } else {
                    console.error('[Prices] HTTP', response.status);
                    document.getElementById('connectionStatus').textContent = 'Error';
                    document.getElementById('connectionStatus').className = 'px-4 py-2 bg-red-600 rounded-lg font-semibold text-sm';
                }
            } catch (error) {
                console.error('[Prices] Fetch failed:', error);
                document.getElementById('connectionStatus').textContent = 'Error';
            }
        }

        // Start polling
        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            
            // Poll every 5 seconds
            pollingInterval = setInterval(fetchPrices, 5000);
            console.log('[Polling] Started (5s interval)');
        }

        // Remove from watchlist
        async function removeFromWatchlist(id) {
            if (!confirm('Remove this instrument from watchlist?')) return;
            
            try {
                console.log('[Remove] Removing watchlist item:', id);
                const response = await fetch(`${API_BASE}/watchlist/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'X-User-Token': USER_TOKEN
                    }
                });

                if (response.ok) {
                    console.log('[Remove] Success');
                    await loadWatchlist();
                } else {
                    console.error('[Remove] Failed:', response.status);
                    alert('Failed to remove instrument');
                }
            } catch (error) {
                console.error('[Remove] Error:', error);
                alert('Failed to remove instrument');
            }
        }

        // Settings modal
        function openSettings() {
            if (userSettings) {
                document.getElementById('accessToken').value = userSettings.access_token || '';
                document.getElementById('clientId').value = userSettings.client_id || '';
            }
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
        }

        async function saveSettings() {
            const accessToken = document.getElementById('accessToken').value.trim();
            const clientId = document.getElementById('clientId').value.trim();

            if (!accessToken || !clientId) {
                alert('Please enter both Access Token and Client ID');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Token': USER_TOKEN
                    },
                    body: JSON.stringify({
                        access_token: accessToken,
                        client_id: clientId
                    })
                });

                if (response.ok) {
                    userSettings = { access_token: accessToken, client_id: clientId };
                    alert('Settings saved successfully!');
                    closeSettings();
                    // Fetch prices immediately
                    fetchPrices();
                } else {
                    alert('Failed to save settings');
                }
            } catch (error) {
                console.error('[Settings] Save failed:', error);
                alert('Failed to save settings');
            }
        }

        // Check if market is open (IST timezone)
        function isMarketOpen() {
            const now = new Date();
            // Convert to IST (UTC+5:30)
            const istOffset = 5.5 * 60; // minutes
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
            const istTime = new Date(utcTime + (istOffset * 60000));
            
            const day = istTime.getDay(); // 0=Sunday, 6=Saturday
            const hours = istTime.getHours();
            const minutes = istTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;
            
            // Weekend check
            if (day === 0 || day === 6) {
                console.log('[Market] Closed (Weekend)');
                return false;
            }
            
            // NSE/BSE: 9:15 AM - 3:30 PM IST
            // TESTING MODE: Extended hours for WebSocket testing
            const marketOpen = 0;  // 12:00 AM (testing)
            const marketClose = 23 * 60 + 59; // 11:59 PM (testing)
            
            const isOpen = timeInMinutes >= marketOpen && timeInMinutes <= marketClose;
            console.log(`[Market] IST Time: ${istTime.toLocaleTimeString()}, Status: ${isOpen ? 'OPEN (Testing Mode)' : 'CLOSED'}`);
            return isOpen;
        }
        
        // Update market status display
        function updateMarketStatus() {
            const marketOpen = isMarketOpen();
            const statusEl = document.getElementById('marketStatus');
            
            if (marketOpen) {
                statusEl.textContent = 'Market Status: OPEN';
                statusEl.className = 'px-4 py-2 bg-green-600 rounded-lg font-semibold text-sm';
            } else {
                statusEl.textContent = 'Market Status: CLOSED';
                statusEl.className = 'px-4 py-2 bg-red-600 rounded-lg font-semibold text-sm';
            }
            
            return marketOpen;
        }

        // WebSocket instance
        let wsHandler = null;
        let restPollInterval = null;
        
        // Start WebSocket streaming
        function startWebSocket() {
            if (!userSettings || !userSettings.access_token) {
                console.log('[WebSocket] No credentials, skipping');
                return;
            }
            
            console.log('[WebSocket] Starting live stream...');
            
            // Load WebSocket handler script
            const script = document.createElement('script');
            script.src = '/websocket-handler.js';
            script.onload = () => {
                wsHandler = new DhanWebSocket(userSettings.access_token, userSettings.client_id);
                
                // Set up ticker update callback
                wsHandler.onTickerUpdate = (data) => {
                    console.log('[WebSocket] Ticker update:', data);
                    
                    // Stop REST polling if WebSocket is receiving data
                    stopRestPolling();
                    
                    // Update price data
                    priceData[data.securityId] = {
                        security_id: data.securityId,
                        ltp: data.ltp,
                        prev_close: priceData[data.securityId]?.prev_close || data.ltp
                    };
                    renderWatchlist();
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                };
                
                // Set up connection status callback
                wsHandler.onConnectionStatus = (status) => {
                    console.log('[WebSocket] Status changed:', status);
                    const statusEl = document.getElementById('connectionStatus');
                    
                    if (status === 'Connected') {
                        statusEl.textContent = 'WebSocket: Connected';
                        statusEl.className = 'text-2xl font-bold text-green-400';
                        
                        // Stop REST polling when WebSocket connects
                        stopRestPolling();
                        
                        // Subscribe to all instruments now that we're connected
                        if (watchlistData.length > 0) {
                            const instruments = watchlistData.map(item => ({
                                securityId: item.security_id,
                                exchangeSegment: item.exchange_segment
                            }));
                            console.log('[WebSocket] Subscribing to', instruments.length, 'instruments:', instruments);
                            wsHandler.subscribe(instruments, 15); // 15 = Ticker mode
                        }
                    } else if (status === 'Connecting...') {
                        statusEl.textContent = 'WebSocket: Connecting...';
                        statusEl.className = 'text-2xl font-bold text-yellow-400';
                    } else if (status === 'Subscribed') {
                        statusEl.textContent = 'WebSocket: Live';
                        statusEl.className = 'text-2xl font-bold text-green-400';
                        
                        // Stop REST polling when subscription is confirmed
                        stopRestPolling();
                    } else if (status === 'Disconnected') {
                        statusEl.textContent = 'WebSocket: Disconnected';
                        statusEl.className = 'text-2xl font-bold text-red-400';
                        
                        // Start REST polling as fallback
                        if (isMarketOpen() && userSettings) {
                            console.log('[WebSocket] Disconnected during market hours, starting REST fallback');
                            startRestPolling();
                        }
                    } else if (status === 'Error') {
                        statusEl.textContent = 'WebSocket: Error';
                        statusEl.className = 'text-2xl font-bold text-red-400';
                        
                        // Start REST polling as fallback
                        if (isMarketOpen() && userSettings) {
                            console.log('[WebSocket] Error during market hours, starting REST fallback');
                            startRestPolling();
                        }
                    } else if (status.startsWith('Reconnecting')) {
                        statusEl.textContent = 'WebSocket: ' + status;
                        statusEl.className = 'text-2xl font-bold text-yellow-400';
                    } else {
                        statusEl.textContent = 'WebSocket: ' + status;
                        statusEl.className = 'text-2xl font-bold text-yellow-400';
                    }
                };
                
                // Connect to WebSocket
                wsHandler.connect();
            };
            document.head.appendChild(script);
        }
        
        // Start REST API polling
        function startRestPolling() {
            console.log('[REST] Starting polling (market closed)...');
            
            if (restPollInterval) {
                clearInterval(restPollInterval);
            }
            
            // Initial fetch
            fetchPrices();
            
            // Poll every 30 seconds when market is closed
            restPollInterval = setInterval(() => {
                fetchPrices();
            }, 30000);
        }
        
        // Stop WebSocket
        function stopWebSocket() {
            if (wsHandler) {
                console.log('[WebSocket] Stopping...');
                wsHandler.disconnect();
                wsHandler = null;
            }
        }
        
        // Stop REST polling
        function stopRestPolling() {
            if (restPollInterval) {
                console.log('[REST] Stopping polling...');
                clearInterval(restPollInterval);
                restPollInterval = null;
            }
        }
        
        // Switch between WebSocket and REST based on market status
        function updateDataSource() {
            const marketOpen = isMarketOpen();
            
            if (marketOpen) {
                // Market is open - use WebSocket
                stopRestPolling();
                if (!wsHandler && userSettings) {
                    startWebSocket();
                }
            } else {
                // Market is closed - use REST API
                stopWebSocket();
                if (userSettings) {
                    startRestPolling();
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[Init] Starting...');
            await loadSettings();
            await loadWatchlist();
            
            // Update market status
            updateMarketStatus();
            
            // Start appropriate data source
            updateDataSource();
            
            // Check market status and switch data source every minute
            setInterval(() => {
                updateMarketStatus();
                updateDataSource();
            }, 60000);
        });
    </script>
</body>
</html>

