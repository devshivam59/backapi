<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DhanHQ Instruments Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
    </style>
</head>
<body class="dark min-h-screen text-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                DhanHQ Instruments Manager
            </h1>
            <p class="text-gray-400">Manage and search through DhanHQ trading instruments</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <h3 class="text-gray-400 text-sm mb-2">Total Instruments</h3>
                <p class="text-3xl font-bold" id="totalCount">0</p>
            </div>
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <h3 class="text-gray-400 text-sm mb-2">Search Results</h3>
                <p class="text-3xl font-bold" id="searchCount">0</p>
            </div>
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                <h3 class="text-gray-400 text-sm mb-2">Quick Actions</h3>
                <button onclick="document.getElementById('csvFile').click()" 
                        class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                    üì§ Upload CSV
                </button>
                <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="uploadCSV()">
            </div>
        </div>

        <!-- Search & Filter -->
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">Search & Filter</h3>
            <p class="text-gray-400 text-sm mb-4">Search by trading symbol, display name, exchange, or segment</p>
            <div class="flex gap-4">
                <div class="flex-1 relative">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search instruments..." 
                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 transition-colors"
                        oninput="debouncedSearch()">
                    <span class="absolute right-4 top-3 text-gray-500">üîç</span>
                </div>
                <button onclick="addInstrument()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
                    ‚ûï Add New
                </button>
                <button onclick="deleteAll()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition-colors">
                    üóëÔ∏è Delete All
                </button>
                <a href="/watchlist.html" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition-colors inline-block">
                    üìä Watchlist
                </a>
            </div>
        </div>

        <!-- Instruments Table -->
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 overflow-hidden">
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-4">Instruments</h3>
                <div class="overflow-x-auto">
                    <table class="w-full" id="instrumentsTable">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="text-left py-3 px-4 text-gray-400 font-medium">Security ID</th>
                                <th class="text-left py-3 px-4 text-gray-400 font-medium">Display Name</th>
                                <th class="text-left py-3 px-4 text-gray-400 font-medium">Exchange</th>
                                <th class="text-left py-3 px-4 text-gray-400 font-medium">Segment</th>
                                <th class="text-left py-3 px-4 text-gray-400 font-medium">Lot Size</th>
                                <th class="text-left py-3 px-4 text-gray-400 font-medium">Expiry</th>
                                <th class="text-left py-3 px-4 text-gray-400 font-medium">Actions</th>
                                <th class="text-left py-3 px-4 text-gray-400 font-medium">Watchlist</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-500">
                                    Loading instruments...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl border border-gray-700 p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4" id="modalTitle">Edit Instrument</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Security ID</label>
                    <input type="text" id="editSecurityId" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Exchange</label>
                    <input type="text" id="editExchange" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Segment</label>
                    <input type="text" id="editSegment" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Trading Symbol</label>
                    <input type="text" id="editTradingSymbol" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                </div>
                <div class="col-span-2">
                    <label class="block text-sm text-gray-400 mb-2">Display Name</label>
                    <input type="text" id="editDisplayName" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Lot Size</label>
                    <input type="number" id="editLotSize" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Expiry Date</label>
                    <input type="date" id="editExpiryDate" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="saveInstrument()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    Save
                </button>
                <button onclick="closeModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://5000-iytom3oluok7lib9x9jul-2ac7958e.manusvm.computer/api';
        let currentInstrumentId = null;
        let searchTimeout = null;

        // Load instruments on page load
        window.onload = () => {
            loadInstruments();
            loadCount();
        };

        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = document.getElementById('searchInput').value.trim();
                if (query) {
                    searchInstruments(query);
                } else {
                    loadInstruments();
                }
            }, 300);
        }

        async function loadInstruments() {
            try {
                const response = await fetch(`${API_BASE}/instruments?limit=100`);
                const instruments = await response.json();
                renderTable(instruments);
                document.getElementById('searchCount').textContent = instruments.length;
            } catch (error) {
                console.error('Error loading instruments:', error);
                showError('Failed to load instruments');
            }
        }

        async function searchInstruments(query) {
            try {
                const response = await fetch(`${API_BASE}/instruments/search?query=${encodeURIComponent(query)}&limit=100`);
                const instruments = await response.json();
                renderTable(instruments);
                document.getElementById('searchCount').textContent = instruments.length;
            } catch (error) {
                console.error('Error searching instruments:', error);
                showError('Search failed');
            }
        }

        async function loadCount() {
            try {
                const response = await fetch(`${API_BASE}/instruments/count`);
                const data = await response.json();
                document.getElementById('totalCount').textContent = data.count.toLocaleString();
            } catch (error) {
                console.error('Error loading count:', error);
            }
        }

        function renderTable(instruments) {
            const tbody = document.getElementById('tableBody');
            
            if (instruments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-gray-500">
                            No instruments found. Upload a CSV file to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = instruments.map(inst => `
                <tr class="border-b border-gray-700 hover:bg-gray-700/30 transition-colors">
                    <td class="py-3 px-4">${inst.security_id || ''}</td>
                    <td class="py-3 px-4">${inst.display_name || ''}</td>
                    <td class="py-3 px-4"><span class="px-2 py-1 bg-blue-900/50 text-blue-300 rounded text-sm">${inst.exchange || ''}</span></td>
                    <td class="py-3 px-4"><span class="px-2 py-1 bg-purple-900/50 text-purple-300 rounded text-sm">${inst.segment || ''}</span></td>
                    <td class="py-3 px-4">${inst.lot_size || 0}</td>
                    <td class="py-3 px-4 text-sm text-gray-400">${inst.expiry_date || '-'}</td>
                    <td class="py-3 px-4">
                        <button onclick="editInstrument(${inst.id})" class="text-blue-400 hover:text-blue-300 mr-3">‚úèÔ∏è Edit</button>
                        <button onclick="deleteInstrument(${inst.id})" class="text-red-400 hover:text-red-300">üóëÔ∏è Delete</button>
                    </td>
                    <td class="py-3 px-4">
                        <button onclick='addToWatchlist("${inst.security_id}", "${inst.exchange}", "${inst.segment}", "${inst.trading_symbol || ''}", "${inst.display_name || ''}")' class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition-colors">
                            ‚≠ê Add
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function uploadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) return;

            // Show progress indicator
            const progressDiv = document.createElement('div');
            progressDiv.id = 'uploadProgress';
            progressDiv.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
            progressDiv.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    <span>Uploading CSV... Please wait</span>
                </div>
            `;
            document.body.appendChild(progressDiv);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/instruments/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                // Remove progress indicator
                document.getElementById('uploadProgress')?.remove();
                
                if (response.ok) {
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
                    successDiv.innerHTML = `
                        <div class="font-semibold mb-2">‚úÖ CSV Uploaded Successfully!</div>
                        <div class="text-sm">Inserted: ${result.inserted} | Updated: ${result.updated}</div>
                    `;
                    document.body.appendChild(successDiv);
                    setTimeout(() => successDiv.remove(), 5000);
                    
                    loadInstruments();
                    loadCount();
                } else {
                    // Show error message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
                    errorDiv.innerHTML = `
                        <div class="font-semibold mb-2">‚ùå Upload Failed</div>
                        <div class="text-sm">${result.error || 'Unknown error'}</div>
                    `;
                    document.body.appendChild(errorDiv);
                    setTimeout(() => errorDiv.remove(), 5000);
                }
            } catch (error) {
                console.error('Error uploading CSV:', error);
                document.getElementById('uploadProgress')?.remove();
                
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
                errorDiv.innerHTML = `
                    <div class="font-semibold mb-2">‚ùå Upload Failed</div>
                    <div class="text-sm">Network error or server unavailable</div>
                `;
                document.body.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }

            fileInput.value = '';
        }

        function addInstrument() {
            currentInstrumentId = null;
            document.getElementById('modalTitle').textContent = 'Add New Instrument';
            document.getElementById('editSecurityId').value = '';
            document.getElementById('editExchange').value = '';
            document.getElementById('editSegment').value = '';
            document.getElementById('editTradingSymbol').value = '';
            document.getElementById('editDisplayName').value = '';
            document.getElementById('editLotSize').value = '';
            document.getElementById('editExpiryDate').value = '';
            document.getElementById('editModal').classList.remove('hidden');
        }

        async function editInstrument(id) {
            try {
                const response = await fetch(`${API_BASE}/instruments?limit=1000`);
                const instruments = await response.json();
                const instrument = instruments.find(i => i.id === id);
                
                if (!instrument) return;

                currentInstrumentId = id;
                document.getElementById('modalTitle').textContent = 'Edit Instrument';
                document.getElementById('editSecurityId').value = instrument.security_id || '';
                document.getElementById('editExchange').value = instrument.exchange || '';
                document.getElementById('editSegment').value = instrument.segment || '';
                document.getElementById('editTradingSymbol').value = instrument.trading_symbol || '';
                document.getElementById('editDisplayName').value = instrument.display_name || '';
                document.getElementById('editLotSize').value = instrument.lot_size || '';
                document.getElementById('editExpiryDate').value = instrument.expiry_date || '';
                document.getElementById('editModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading instrument:', error);
            }
        }

        async function saveInstrument() {
            const data = {
                security_id: document.getElementById('editSecurityId').value,
                exchange: document.getElementById('editExchange').value,
                segment: document.getElementById('editSegment').value,
                trading_symbol: document.getElementById('editTradingSymbol').value,
                display_name: document.getElementById('editDisplayName').value,
                lot_size: parseFloat(document.getElementById('editLotSize').value) || 0,
                expiry_date: document.getElementById('editExpiryDate').value || null,
                instrument_name: '',
                strike_price: 0,
                option_type: '',
                tick_size: 0,
                expiry_flag: '',
                instrument_type: '',
                series: '',
                symbol_name: ''
            };

            try {
                const url = currentInstrumentId 
                    ? `${API_BASE}/instruments/${currentInstrumentId}`
                    : `${API_BASE}/instruments`;
                
                const method = currentInstrumentId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    loadInstruments();
                    loadCount();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error saving instrument:', error);
                alert('Failed to save instrument');
            }
        }

        async function deleteInstrument(id) {
            if (!confirm('Are you sure you want to delete this instrument?')) return;

            try {
                const response = await fetch(`${API_BASE}/instruments/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadInstruments();
                    loadCount();
                }
            } catch (error) {
                console.error('Error deleting instrument:', error);
                alert('Failed to delete instrument');
            }
        }

        async function deleteAll() {
            if (!confirm('Are you sure you want to delete ALL instruments? This cannot be undone!')) return;

            try {
                const response = await fetch(`${API_BASE}/instruments/bulk-delete`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadInstruments();
                    loadCount();
                }
            } catch (error) {
                console.error('Error deleting instruments:', error);
                alert('Failed to delete instruments');
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function showError(message) {
            alert(message);
        }

        // Add to watchlist
        async function addToWatchlist(securityId, exchange, segment, tradingSymbol, displayName) {
            // Get or create persistent user token
            let USER_TOKEN = localStorage.getItem('dhanhq_user_token');
            if (!USER_TOKEN) {
                USER_TOKEN = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('dhanhq_user_token', USER_TOKEN);
            }
            
            // Map exchange and segment to DhanHQ format
            let exchangeSegment = exchange;
            if (exchange === 'BSE') {
                if (segment === 'C') exchangeSegment = 'BSE_CURRENCY';
                else if (segment === 'D') exchangeSegment = 'BSE_FNO';
                else exchangeSegment = 'BSE_EQ';
            } else if (exchange === 'NSE') {
                if (segment === 'C') exchangeSegment = 'NSE_CURRENCY';
                else if (segment === 'D') exchangeSegment = 'NSE_FNO';
                else exchangeSegment = 'NSE_EQ';
            } else if (exchange === 'MCX') {
                exchangeSegment = 'MCX_COMM';
            }
            
            try {
                const response = await fetch(`${API_BASE}/watchlist`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Token': USER_TOKEN
                    },
                    body: JSON.stringify({
                        security_id: securityId,
                        exchange_segment: exchangeSegment,
                        trading_symbol: tradingSymbol,
                        display_name: displayName
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Added to watchlist! Visit the Watchlist page to see live prices.');
                } else if (response.status === 400) {
                    alert('‚ö†Ô∏è Already in watchlist');
                } else {
                    throw new Error('Failed to add to watchlist');
                }
            } catch (error) {
                console.error('Error adding to watchlist:', error);
                alert('‚ùå Failed to add to watchlist: ' + error.message);
            }
        }
    </script>
</body>
</html>

